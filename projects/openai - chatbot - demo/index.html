<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Chatbot Demo</title>
    <style>
      :root {
        --bg: #0f172a;
        --panel: #0b1220;
        --border: rgba(255, 255, 255, 0.08);
        --text: #e5e7eb;
        --muted: #9ca3af;
        --user: #2563eb;
        --bot: #1f2937;
        --input: #0b1220;
        --btn: #2563eb;
      }

      * { box-sizing: border-box; }

      body {
        margin: 0;
        font-family: Arial, sans-serif;
        background: var(--bg);
        color: var(--text);
        display: flex;
        justify-content: center;
        padding: 28px;
      }

      .app {
        width: 100%;
        max-width: 760px;
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 14px;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      }

      .header {
        padding: 14px 16px;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }

      .header h2 {
        margin: 0;
        font-size: 16px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .meta {
        font-size: 12px;
        color: var(--muted);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 45%;
      }

      .controls {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .pill {
        display: inline-block;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: rgba(255,255,255,0.04);
        color: var(--text);
        font-size: 12px;
      }

      select.pill {
        cursor: pointer;
        outline: none;
      }

      button.pill {
        cursor: pointer;
      }

      #chat {
        height: 420px;
        overflow-y: auto;
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.0));
      }

      .row { display: flex; }
      .row.user { justify-content: flex-end; }
      .row.bot  { justify-content: flex-start; }

      .bubble {
        max-width: 78%;
        padding: 10px 12px;
        border-radius: 14px;
        line-height: 1.35;
        white-space: pre-wrap;
        word-wrap: break-word;
        border: 1px solid rgba(255,255,255,0.08);
      }

      .bubble.user {
        background: var(--user);
        color: #fff;
        border-top-right-radius: 6px;
      }

      .bubble.bot {
        background: var(--bot);
        color: var(--text);
        border-top-left-radius: 6px;
      }

      .bubble .label {
        display: block;
        font-size: 11px;
        margin-bottom: 6px;
        opacity: 0.8;
      }

      .composer {
        border-top: 1px solid var(--border);
        padding: 12px;
        display: flex;
        gap: 10px;
        background: rgba(0,0,0,0.15);
      }

      .composer input {
        flex: 1;
        padding: 12px 12px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: var(--input);
        color: var(--text);
        outline: none;
      }

      .composer button {
        padding: 12px 14px;
        border-radius: 10px;
        border: 1px solid rgba(255,255,255,0.12);
        background: var(--btn);
        color: #fff;
        cursor: pointer;
        font-weight: 700;
      }

      .composer button:disabled {
        opacity: 0.55;
        cursor: not-allowed;
      }

      .faq-panel {
        border-top: 1px solid var(--border);
        padding: 12px 16px;
        display: none;
        gap: 8px;
        flex-direction: column;
      }

      .faq-panel textarea {
        width: 100%;
        min-height: 110px;
        resize: vertical;
        padding: 10px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: var(--input);
        color: var(--text);
        outline: none;
        font-family: Arial, sans-serif;
        line-height: 1.3;
      }

      .hint {
        color: var(--muted);
        font-size: 12px;
      }

      code { opacity: 0.9; }
    </style>
  </head>

  <body>
    <div class="app">
      <div class="header">
        <h2>Chatbot Demo <span class="pill">Streaming</span></h2>

        <div class="controls">
          
          <select id="modeSelect" class="pill">
            <option value="assistant">Assistant</option>
            <option value="strict">Strict assistant</option>
            <option value="faq">FAQ</option>
          </select>

          <div class="meta" id="sessionMeta"></div>
          <button id="newChatBtn" class="pill">New session</button>
        </div>
      </div>

      <div id="chat"></div>

      <div class="faq-panel" id="faqPanel">
        <div class="hint">
          FAQ mode: the bot answers only from this context. If it’s not in here, it replies “I don’t know.”
        </div>
        <textarea id="faqContext" placeholder="Paste your FAQ context here…"></textarea>
      </div>

      <form class="composer" id="chatForm">
        <input id="messageInput" type="text" placeholder="Type a message…" autocomplete="off" />
        <button id="sendBtn" type="submit">Send</button>
      </form>

      <div class="faq-panel" style="display:flex;">
        <div class="hint">
          Memory works within a session (browser stores <code>session_id</code>; server keeps history in RAM).
        </div>
      </div>
    </div>

    <script>
      const chat = document.getElementById("chat");
      const form = document.getElementById("chatForm");
      const input = document.getElementById("messageInput");
      const sendBtn = document.getElementById("sendBtn");
      const sessionMeta = document.getElementById("sessionMeta");
      const newChatBtn = document.getElementById("newChatBtn");

      const modeSelect = document.getElementById("modeSelect");
      const faqPanel = document.getElementById("faqPanel");
      const faqContextEl = document.getElementById("faqContext");

      // --- Stable session id (makes conversation memory work) ---
      let sessionId = localStorage.getItem("session_id");
      if (!sessionId) {
        sessionId = crypto.randomUUID();
        localStorage.setItem("session_id", sessionId);
      }
      sessionMeta.textContent = `session: ${sessionId}`;

      function scrollToBottom() {
        chat.scrollTop = chat.scrollHeight;
      }

      function addBubble(role, text) {
        const row = document.createElement("div");
        row.className = `row ${role}`;

        const bubble = document.createElement("div");
        bubble.className = `bubble ${role}`;

        const label = document.createElement("span");
        label.className = "label";
        label.textContent = role === "user" ? "You" : "Bot";

        const content = document.createElement("div");
        content.textContent = text || "";

        bubble.appendChild(label);
        bubble.appendChild(content);
        row.appendChild(bubble);
        chat.appendChild(row);

        scrollToBottom();
        return content;
      }

      function setBusy(isBusy) {
        sendBtn.disabled = isBusy;
        input.disabled = isBusy;
        modeSelect.disabled = isBusy;
        faqContextEl.disabled = isBusy;
        newChatBtn.disabled = isBusy;
      }

      function startNewChat() {
        sessionId = crypto.randomUUID();
        localStorage.setItem("session_id", sessionId);
        sessionMeta.textContent = `session: ${sessionId}`;
        chat.innerHTML = "";
      }

      newChatBtn.addEventListener("click", startNewChat);

      function updateModeUI() {
        const mode = modeSelect.value;
        faqPanel.style.display = (mode === "faq") ? "flex" : "none";
      }

      modeSelect.addEventListener("change", updateModeUI);
      updateModeUI();

      form.onsubmit = async (e) => {
        e.preventDefault();

        const text = input.value.trim();
        if (!text) return;

        const mode = modeSelect.value;
        const faqContext = faqContextEl.value;

        addBubble("user", text);
        input.value = "";

        const botContent = addBubble("bot", "");
        setBusy(true);

        try {
          const res = await fetch("/chat-stream", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              message: text,
              session_id: sessionId,
              mode: mode,
              faq_context: mode === "faq" ? faqContext : null
            })
          });

          if (!res.ok) {
            botContent.textContent = `Error: ${res.status} ${res.statusText}`;
            return;
          }

          if (!res.body) {
            botContent.textContent = "Error: no response body (stream not available).";
            return;
          }

          const reader = res.body.getReader();
          const decoder = new TextDecoder();
          let botText = "";

          while (true) {
            const { value, done } = await reader.read();
            if (done) break;
            const chunk = decoder.decode(value, { stream: true });
            botText += chunk;
            botContent.textContent = botText;
            scrollToBottom();
          }
        } catch (err) {
          botContent.textContent = "Something went wrong. Check your connection and try again.";
        } finally {
          setBusy(false);
          input.focus();
        }
      };

      input.focus();
    </script>
  </body>
</html>
